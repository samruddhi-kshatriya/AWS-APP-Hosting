<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Add Expense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tap:active { transform: scale(0.96); transition: 0.1s; }
    </style>
</head>
<body class="bg-slate-50 p-6">

    <div id="budget-toast" class="fixed top-5 left-6 right-6 bg-red-600 text-white p-5 rounded-[2rem] shadow-2xl z-[200] transform -translate-y-64 transition-transform duration-500 flex items-center gap-4">
        <span class="text-2xl">⚠️</span>
        <div>
            <p class="font-black text-[10px] uppercase tracking-widest leading-none mb-1">Budget Warning</p>
            <p id="toast-msg" class="text-xs font-bold opacity-90">You have used over 80% of your budget!</p>
        </div>
    </div>

    <div class="max-w-md mx-auto bg-white p-8 rounded-[3rem] shadow-2xl mt-10 border border-slate-100">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-2xl text-red-600 shadow-inner">➖</div>
            <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Add Expense</h2>
        </div>
        
        <form id="expense-form" class="space-y-5">
            <input type="number" id="expense-amount" placeholder="Amount (₹)" required class="w-full p-5 bg-slate-50 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-100 font-bold text-lg border-none">
            <input type="text" id="expense-category" placeholder="Category (e.g. Food)" required class="w-full p-5 bg-slate-50 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-100 font-bold border-none">
            <input type="date" id="expense-date" required class="w-full p-5 bg-slate-50 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-100 font-bold border-none text-slate-500">
            <input type="text" id="expense-note" placeholder="Note (Optional)" class="w-full p-5 bg-slate-50 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-100 font-bold border-none">
            
            <button type="submit" id="save-btn" class="w-full bg-indigo-600 text-white p-5 rounded-3xl font-black uppercase tracking-widest shadow-xl shadow-indigo-200 tap mt-4">Save Record</button>
            <a href="index.html" class="block text-center text-slate-400 text-[10px] font-black uppercase tracking-widest pt-4">Cancel / Back</a>
        </form>
    </div>

<script>
const API_URL = "https://ku5l46l1li.execute-api.ap-south-1.amazonaws.com/prod/expense";

/* ✅ FIX 1 – define expenses */
const expenses = JSON.parse(localStorage.getItem("expenses_db")) || [];

document.getElementById('expense-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('save-btn');
    
    const amount = Math.abs(Number(document.getElementById('expense-amount').value));
    const category = document.getElementById('expense-category').value;
    const date = document.getElementById('expense-date').value;
    const note = document.getElementById('expense-note').value;

    const payload = {
        Id: Date.now().toString(),
        amount: amount,
        category: category,
        date: date,
        note: note
    };

    /* ✅ FIX 2 – save locally (this was missing) */
    expenses.push(payload);
    localStorage.setItem("expenses_db", JSON.stringify(expenses));

    // 3. Budget Alert Logic (80% Check)
    const incomes = JSON.parse(localStorage.getItem("income_db")) || [];
    const totalExp = expenses.reduce((a, b) => a + Number(b.amount), 0);
    const totalInc = incomes.reduce((a, b) => a + Number(b.amount), 0);

    if (totalInc > 0 && (totalExp / totalInc) >= 0.8) {
        const toast = document.getElementById('budget-toast');
        document.getElementById('toast-msg').innerText =
            `Warning: You've used ${Math.round((totalExp/totalInc)*100)}% of your budget.`;
        toast.classList.remove('-translate-y-64');
        await new Promise(r => setTimeout(r, 1200));
    }

    btn.innerText = "Syncing...";
    btn.disabled = true;

    try {
        await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        setTimeout(() => {
            window.location.href = "index.html";
        }, 150);

    } catch (err) {
        console.error("AWS Sync failed, but data is saved in browser.", err);

        setTimeout(() => {
            window.location.href = "index.html";
        }, 150);
    }
};

document.getElementById('expense-date').valueAsDate = new Date();
</script>

</body>
</html>
